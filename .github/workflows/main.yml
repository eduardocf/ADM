name: Build and Publish Dependency Graph

on:
  schedule:
    - cron: '*/5 * * * *'  # Every 5 minutes
  workflow_dispatch:

jobs:
  dependency-map:
    runs-on: windows-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Clone application repositories
        run: |
          $repos = @("Application01", "Application02", "Application03", "Application04", "Application05")
          foreach ($repo in $repos) {
            git clone https://x-access-token:${{ secrets.GH_PAT }}@github.com/eduardocf/$repo.git
          }
        shell: pwsh

      - name: Extract dependencies (.NET)
        shell: pwsh
        run: |
          $repos = @("Application01", "Application02", "Application03", "Application04", "Application05")
          $result = @()
          foreach ($repo in $repos) {
              Set-Location $repo
              $dependencies = @{}

              Get-ChildItem -Recurse -Filter *.csproj | ForEach-Object {
                [xml]$xml = Get-Content $_.FullName
                $pkg = $xml.Project.ItemGroup.PackageReference | ForEach-Object { $_.Include }
                if ($pkg) {
                  $project = Split-Path $_.Directory.FullName -Leaf
                  $dependencies[$project] = $pkg
                }
              }

              Get-ChildItem -Recurse -Filter packages.config | ForEach-Object {
                [xml]$xml = Get-Content $_.FullName
                $pkg = $xml.packages.package | ForEach-Object { $_.id }
                $project = Split-Path $_.Directory.FullName -Leaf
                if ($dependencies.ContainsKey($project)) {
                  $dependencies[$project] += $pkg
                } else {
                  $dependencies[$project] = $pkg
                }
              }

              foreach ($d in $dependencies.GetEnumerator()) {
                $result += [PSCustomObject]@{ project = $d.Key; dependencies = $d.Value | Sort-Object -Unique }
              }

              Set-Location ..
          }

          $result | ConvertTo-Json -Depth 3 | Out-File dependencies.json -Encoding utf8

      - name: Create DOT file from JSON
        shell: pwsh
        run: |
          $json = Get-Content dependencies.json | ConvertFrom-Json
          $lines = @("digraph Dependencies {", "  rankdir=LR;")
          foreach ($item in $json) {
            foreach ($dep in $item.dependencies) {
              $lines += "  `"$($item.project)`" -> `"$dep`";"
            }
          }
          $lines += "}"
          $lines | Out-File dependency_graph.dot -Encoding utf8

      - name: Install Graphviz and render SVG
        run: |
          choco install graphviz -y
          mkdir artifacts
          dot -Tsvg dependency_graph.dot -o artifacts/graph.svg

      - name: Inline SVG into index.html
        shell: pwsh
        run: |
          $svg = Get-Content artifacts/graph.svg -Raw
          $html = @"
          <!DOCTYPE html>
          <html lang='en'>
          <head>
            <meta charset='UTF-8'>
            <meta name='viewport' content='width=device-width, initial-scale=1.0'>
            <title>Dependency Graph</title>
            <style>
              body { font-family: 'Segoe UI', sans-serif; background: #f5f5f5; text-align: center; margin: 0; padding: 2rem; }
              header { background: #0366d6; color: white; padding: 1rem; }
              svg { max-width: 100%; height: auto; background: white; border: 1px solid #ccc; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-top: 2rem; }
              footer { margin-top: 2rem; color: #555; font-size: 0.9rem; }
            </style>
          </head>
          <body>
            <header>
              <h1>ðŸ“Œ Application Dependency Graph</h1>
              <p>Updated automatically every 5 minutes</p>
            </header>
            <div class="svg-container">
            $svg
            </div>
            <footer>Generated by GitHub Actions and Graphviz</footer>
          </body>
          </html>
          "@
          $html | Out-File artifacts/index.html -Encoding utf8
          Move-Item dependencies.json artifacts/
          Move-Item dependency_graph.dot artifacts/

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: ./artifacts
