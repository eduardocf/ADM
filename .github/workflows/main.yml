name: Build and Publish Interactive Dependency Graph

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  dependency-map:
    runs-on: windows-latest

    steps:
      - name: Checkout orchestrator repo
        uses: actions/checkout@v3

      - name: Clone application repositories
        shell: pwsh
        run: |
          $repos = @("Application01", "Application02", "Application03", "Application04", "Application05")
          foreach ($repo in $repos) {
            git clone https://x-access-token:${{ secrets.GH_PAT }}@github.com/eduardocf/$repo.git
          }

      - name: Extract all dependencies
        shell: pwsh
        run: |
          $repos = @("Application01", "Application02", "Application03", "Application04", "Application05")
          $result = @()
          foreach ($repo in $repos) {
              Set-Location $repo
              $projectDependencies = @{}
              $csprojFiles = Get-ChildItem -Recurse -Filter *.csproj -ErrorAction SilentlyContinue

              foreach ($file in $csprojFiles) {
                  [xml]$xml = Get-Content $file.FullName
                  $projectName = Split-Path $file.Directory.FullName -Leaf
                  $deps = @()

                  $deps += $xml.Project.ItemGroup.PackageReference | ForEach-Object { $_.Include }
                  $deps += $xml.Project.ItemGroup.COMReference | ForEach-Object { $_.Include }
                  $deps += $xml.Project.ItemGroup.Reference |
                    Where-Object { $_.Include -match "Application" -or $_.HintPath -match "Application" } |
                    ForEach-Object { $_.Include }

                  if ($deps.Count -gt 0) {
                    $projectDependencies[$projectName] = $deps
                  }
              }

              $pkgFiles = Get-ChildItem -Recurse -Filter packages.config -ErrorAction SilentlyContinue
              foreach ($file in $pkgFiles) {
                  [xml]$xml = Get-Content $file.FullName
                  $pkgIds = $xml.packages.package | ForEach-Object { $_.id }
                  $projectName = Split-Path $file.Directory.FullName -Leaf

                  if ($projectDependencies.ContainsKey($projectName)) {
                    $projectDependencies[$projectName] += $pkgIds
                  } else {
                    $projectDependencies[$projectName] = $pkgIds
                  }
              }

              foreach ($entry in $projectDependencies.GetEnumerator()) {
                  $result += [PSCustomObject]@{
                      project = $entry.Key
                      dependencies = $entry.Value | Sort-Object -Unique
                  }
              }

              Set-Location ..
          }

          $result | ConvertTo-Json -Depth 3 | Out-File dependencies.json -Encoding utf8

      - name: Generate .dot file
        shell: pwsh
        run: |
          $json = Get-Content dependencies.json | ConvertFrom-Json
          $dot = "digraph Dependencies {`n  rankdir=LR;"
          foreach ($item in $json) {
              foreach ($dep in $item.dependencies) {
                  if ($dep -and $dep -ne $item.project) {
                      $dot += "`n  `"$($item.project)`" -> `"$($dep)`";"
                  }
              }
          }
          $dot += "`n}"
          New-Item -ItemType Directory -Force -Path artifacts | Out-Null
          $dot | Out-File artifacts/dependency_graph.dot -Encoding utf8

      - name: Generate interactive index.html
        shell: pwsh
        run: |
          $dot = Get-Content artifacts/dependency_graph.dot -Raw
          $html = @"
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset='utf-8'>
            <title>Interactive Dependency Graph</title>
            <script src='https://unpkg.com/viz.js@2.1.2/viz.js'></script>
            <script src='https://unpkg.com/viz.js@2.1.2/full.render.js'></script>
            <style>
              body { font-family: 'Segoe UI', sans-serif; background: #f5f5f5; text-align: center; margin: 0; padding: 2rem; }
              header { background: #0366d6; color: white; padding: 1rem; }
              #graph { margin-top: 2rem; }
              svg { width: 100%; height: auto; border: 1px solid #ccc; background: white; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
            </style>
          </head>
          <body>
            <header>
              <h1>ðŸ“Œ Interactive Application Dependency Graph</h1>
              <p>Updated every 5 minutes via GitHub Actions</p>
            </header>
            <div id='graph'></div>
            <script>
              const raw = `digraph Dependencies {
                rankdir=LR;
                "App04" -> "App03";
                "App04" -> "App05";
                "App01" -> "Newtonsoft.Json";
                // ... other dependencies
              }`;
            
              document.addEventListener("DOMContentLoaded", () => {
                const viz = new Viz();
                viz.renderSVGElement(raw)
                  .then(svg => document.getElementById('graph').appendChild(svg))
                  .catch(error => {
                    console.error("Viz.js error:", error);
                    document.getElementById('graph').innerHTML = "<p style='color:red;'>Graph render failed.</p>";
                  });
              });
            </script>
          </body>
          </html>
          "@
          $html | Out-File artifacts/index.html -Encoding utf8

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: ./artifacts
          user_name: github-actions[bot]
          user_email: github-actions[bot]@users.noreply.github.com
